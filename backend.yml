- name: Expense Backend Setup
  hosts: all
  become: yes
  tasks:
    -name: Disable NodeJs default version
      ansible.builtin.shell:
      dnf module disable nodejs -y

    -name: Enable NodeJS 18 version
    ansible:builtin.shell:
      dnf module enable nodejs -y

    -name: Install NodeJS
      ansible:builtin.dnf:
        name: nodejs
        state: present

        -name: Copy Backend Service File
          ansible.builtin.copy:
            src: backend.service
            dest: /etc/systemd/system/backend.service

        -name: Add Application User
          ansible.builtin.user:
        name: expense

        -name: Delete Old App Dir
          ansible.builtin.file:
          path: /app
            state: absent

        -name: Create Ngnix Dir
          ansible.builtin.file:
            path: /app
          state: directory

          -name: Download and Extract Backend Content
            ansible.builtin.unarchive
            src:
              https: https://expense-artifacts.s3.amazonaws.com/backend.zip
              dest: /app
                remote_src:yes

          -name: Download NodeJs Dependancies
ansible.builtin.shell:
  -npm install
  args:
    chir: /app

      -name: Install Mysql client
      ansible.builtin.dnf
      name: mysql
      state: present

    -name: Load Schema
      ansible.builtin.shell:
  mysql -h mysql-dev.anjumdevops.online -uroot -p{{MYSQL_ROOT_PASSWORD}}< /app/schema/backend.sql

  -name: Start Backend Service
  ansible.builtin.systemd:
    name: backend
    state: restarted
    enabled: yes
    daemon-reload: yes


